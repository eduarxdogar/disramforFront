<div class="p-6 max-w-4xl mx-auto space-y-6">
  <h2 class="text-2xl font-bold">{{ isEdit ? 'Editar Pedido' : 'Nuevo Pedido' }}</h2>

  <form [formGroup]="form" (ngSubmit)="save()">
    <!-- Cliente + Asesor -->
    <div class="grid grid-cols-2 gap-4">
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Buscar cliente (NIT o nombre)</mat-label>
        <input matInput
               formControlName="clienteInput"
               (input)="filtrarClientes($any($event.target).value)"
               [matAutocomplete]="autoCliente">
        <mat-autocomplete #autoCliente="matAutocomplete"
                          (optionSelected)="onClienteSelected($event.option.value)">
          <mat-option *ngFor="let c of clientesFiltrados" [value]="c">
            {{ c.nit }} – {{ c.nombre }}
          </mat-option>
        </mat-autocomplete>
        <mat-error *ngIf="form.get('cliente')?.hasError('required')">
          Debes seleccionar un cliente
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Asesor</mat-label>
        <input matInput [value]="asesor" disabled>
        <mat-icon matSuffix>person</mat-icon>
      </mat-form-field>
    </div>

    <!-- Agregar ítem por código -->
    <mat-form-field appearance="outline" class="w-full">
      <mat-label>Agregar producto por código</mat-label>
      <input matInput
             formControlName="productoSearch"
             [matAutocomplete]="autoProd"
             (input)="filtrarProductos(form.get('productoSearch')!.value)"
             placeholder="Escribe código…">
      <mat-autocomplete #autoProd="matAutocomplete"
                        (optionSelected)="onProductoSelected($event.option.value)">
        <mat-option *ngFor="let p of productosFiltrados" [value]="p">
          <div class="flex items-center gap-2">
            <img class="h-8 w-8 object-contain"
                 [src]="'assets/' + p.codigo + '.jpeg'"
                 alt="{{p.nombre}}">
            <span>{{ p.codigo }} – {{ p.nombre }}</span>
          </div>
        </mat-option>
      </mat-autocomplete>
      <button mat-icon-button matSuffix (click)="clearProductoSearch()">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>

    <!-- Lista de ítems -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <ng-container *ngFor="let item of items.controls; let i = index">
        <mat-card class="relative p-4">
          <button mat-icon-button color="warn"
                  class="absolute top-2 right-2"
                  (click)="removeItem(i)">
            <mat-icon>close</mat-icon>
          </button>

          <div class="flex items-center gap-4">
            <img class="h-16 w-16 object-contain"
                 [src]="'assets/' + item.get('productoCodigo')!.value + '.jpeg'"
                 alt="Producto">
            <div>
              <h3 class="font-semibold">{{ getProducto(i)?.nombre }}</h3>
              <p class="text-sm text-gray-600">
                Código: {{ item.get('productoCodigo')!.value }}
              </p>
            </div>
          </div>

          <div class="mt-4 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <button mat-mini-button (click)="decreaseQty(i)"
                      [disabled]="getCantidadControl(i).value<=1">
                <mat-icon>remove</mat-icon>
              </button>
              <input matInput type="number" class="w-12 text-center"
                     [formControl]="getCantidadControl(i)" min="1">
              <button mat-mini-button (click)="increaseQty(i)">
                <mat-icon>add</mat-icon>
              </button>
            </div>
            <div class="font-bold">
              {{ getSubtotal(i) | currency:'COP' }}
            </div>
          </div>
        </mat-card>
      </ng-container>
    </div>

    <!-- Total + botones -->
    <div class="mt-6 flex justify-between items-center">
      <div class="text-xl font-semibold">
        Total: {{ totalConIva | currency:'COP' }}
      </div>
      <div class="flex gap-2">
        <button mat-stroked-button color="warn" type="button" routerLink="/pedidos">Cancelar</button>
        <button mat-flat-button color="primary" [disabled]="form.invalid || items.length===0">
          {{ isEdit ? 'Actualizar' : 'Guardar Pedido' }}
        </button>
      </div>
    </div>
  </form>
</div>