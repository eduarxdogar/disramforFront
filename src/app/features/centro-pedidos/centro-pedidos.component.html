<div class="max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8">
    <header class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
        <div class="flex items-center gap-4">
            <img src="assets/disramfor.jpg" alt="Logo DISRAMFOR" class="h-10">
            <div>
                <h1 class="text-xl font-bold text-slate-800">A.S.T. CATALOG</h1>
                <p class="text-sm text-slate-500">Innovación en juntas para motor</p>
            </div>
        </div>
        <div class="text-sm text-right">
            <p><strong>Asesor:</strong> Cristian Developer</p>
            <p><strong>Cliente:</strong> 
                <span *ngIf="selectedClient" class="font-semibold text-blue-600">{{ selectedClient.nombre }}</span>
                <span *ngIf="!selectedClient" class="text-slate-500">Ninguno seleccionado</span>
            </p>
        </div>
    </header>

    <div class="grid lg:grid-cols-12 gap-6">
        <!-- COLUMNA IZQUIERDA: SELECCIÓN DE CLIENTE Y FILTROS -->
        <aside class="lg:col-span-3 space-y-6">
            
            <!-- NUEVA SECCIÓN: SELECCIÓN DE CLIENTE -->
            <div class="bg-white rounded-lg shadow-sm p-5">
                <h3 class="text-base font-semibold mb-4">1. SELECCIONAR CLIENTE</h3>
                <mat-form-field class="w-full" appearance="outline">
                    <mat-label>Buscar cliente por NIT o Nombre</mat-label>
                    <input type="text" matInput [formControl]="clienteControl" [matAutocomplete]="autoCliente" [readonly]="!!selectedClient">
                    <mat-autocomplete #autoCliente="matAutocomplete" [displayWith]="displayCliente" (optionSelected)="onClientSelected($event)">
                        <mat-option *ngFor="let cliente of filteredClientes$ | async" [value]="cliente">
                            <span class="font-semibold">{{ cliente.nombre }}</span>
                            <br>
                            <small>NIT: {{ cliente.nit }}</small>
                        </mat-option>
                    </mat-autocomplete>
                    <button *ngIf="selectedClient" mat-icon-button matSuffix (click)="clearClientSelection()" title="Limpiar cliente">
                        <mat-icon>close</mat-icon>
                    </button>
                </mat-form-field>
            </div>

            <!-- FILTROS DE PRODUCTO (Ahora deshabilitados hasta que se seleccione un cliente) -->
            <div class="bg-white rounded-lg shadow-sm p-5" [class.opacity-50]="!selectedClient">
                <h3 class="text-base font-semibold mb-4">2. FILTRAR PRODUCTOS</h3>
                <fieldset [disabled]="!selectedClient" class="space-y-4" [formGroup]="filterForm">
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Nombre o Código</mat-label>
                        <input matInput formControlName="termino" placeholder="Ej: Junta Culata o JCY25">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Categoría</mat-label>
                        <mat-select formControlName="categoriaId">
                            <mat-option [value]="null">Todas las categorías</mat-option>
                            <mat-option *ngFor="let cat of categorias" [value]="cat.id">{{ cat.nombre }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </fieldset>
            </div>
        </aside>

        <!-- COLUMNA DERECHA: CATÁLOGO Y PEDIDO -->
        <main class="lg:col-span-9 space-y-6">
            <div class="bg-white rounded-lg shadow-sm p-5">
                <h3 class="text-lg font-semibold mb-4">CATÁLOGO DE PRODUCTOS</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4" *ngIf="productos.length > 0; else noProductos">
                    <mat-card *ngFor="let p of productos" class="flex flex-col">
                        <img mat-card-image 
                             [src]="p.imagenUrl ? 'assets/' + p.imagenUrl : 'assets/nombre.jpeg'" 
                             [alt]="p.nombre" 
                             class="h-40 object-contain p-2">
                        <mat-card-content class="text-center p-4 flex-grow">
                            <p class="font-semibold text-sm min-h-[2.5rem]" title="{{ p.nombre }}">{{ p.nombre }}</p>
                            <p class="text-slate-500 text-xs mb-2">CÓD: {{ p.codigo }}</p>
                            <p class="font-bold text-lg my-2">{{ p.precioUnitario | currency:'COP':'symbol-narrow':'1.0-0' }}</p>
                        </mat-card-content>
                        <mat-card-actions class="justify-center p-4 pt-0">
                            <button mat-flat-button color="primary" (click)="agregarAlPedido(p)" [disabled]="!selectedClient">Agregar</button>
                        </mat-card-actions>
                    </mat-card>
                </div>
                <ng-template #noProductos>
                    <p class="text-center text-slate-500 py-8">No se encontraron productos para los filtros seleccionados.</p>
                </ng-template>

                <mat-paginator class="mt-4 bg-white" [length]="totalElements" [pageSize]="pageSize" [pageSizeOptions]="[8, 16, 24]" (page)="onPageChange($event)"></mat-paginator>
            </div>

            <div class="bg-white rounded-lg shadow-sm p-5">
                <h3 class="text-lg font-semibold mb-4">PEDIDO ACTUAL</h3>
                <div *ngIf="pedidoActual.length > 0; else pedidoVacio">
                    <table mat-table [dataSource]="pedidoActual" class="w-full">
                        <ng-container matColumnDef="nombre">
                            <th mat-header-cell *matHeaderCellDef> Producto </th>
                            <td mat-cell *matCellDef="let item"> {{item.nombre}} </td>
                        </ng-container>
                        <ng-container matColumnDef="cantidad">
                            <th mat-header-cell *matHeaderCellDef class="text-center"> Cant. </th>
                            <td mat-cell *matCellDef="let item">
                                <input type="number" [value]="item.cantidad" (change)="actualizarCantidad(item.codigo, $event)" class="w-16 text-center border rounded-md p-1">
                            </td>
                        </ng-container>
                        <ng-container matColumnDef="precioUnitario">
                            <th mat-header-cell *matHeaderCellDef class="text-right"> Precio Unit. </th>
                            <td mat-cell *matCellDef="let item" class="text-right"> {{ item.precioUnitario | currency:'COP':'symbol-narrow':'1.0-0' }} </td>
                        </ng-container>
                        <ng-container matColumnDef="total">
                            <th mat-header-cell *matHeaderCellDef class="text-right"> Total </th>
                            <td mat-cell *matCellDef="let item" class="text-right font-semibold"> {{ (item.precioUnitario * item.cantidad) | currency:'COP':'symbol-narrow':'1.0-0' }} </td>
                        </ng-container>
                        <ng-container matColumnDef="acciones">
                            <th mat-header-cell *matHeaderCellDef></th>
                            <td mat-cell *matCellDef="let item">
                                <button mat-icon-button color="warn" (click)="eliminarDelPedido(item.codigo)" title="Eliminar item">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </td>
                        </ng-container>
                        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                    </table>
                    <div class="flex justify-between items-center mt-4 pt-4 border-t">
                        <button mat-stroked-button color="warn" (click)="limpiarPedido()">Limpiar Pedido</button>
                        <div class="flex items-center gap-4">
                            <span class="text-lg font-bold">Total: {{ getSubtotal() | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
                            <button mat-flat-button color="primary" class="ml-4" (click)="finalizarPedido()">Finalizar Pedido</button>
                        </div>
                    </div>
                </div>
                <ng-template #pedidoVacio>
                    <p class="text-center text-slate-500 py-6">Seleccione un cliente para iniciar un pedido.</p>
                </ng-template>
            </div>
        </main>
    </div>
</div>
